import{g as h}from"./storage-uVl3v7f4.js";function y(t){return typeof t=="object"&&t!==null&&"kind"in t&&t.kind==="READ_SELECTION"}function x(t){return typeof t=="object"&&t!==null&&"kind"in t&&t.kind==="READ_TEXT"&&"text"in t&&typeof t.text=="string"}function w(t){return y(t)||x(t)}async function b(){const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});return!t?.id||!t.url||!/^https?:|^file:/.test(t.url)?null:t}async function d(t){const a=await b();if(!a){console.warn("[readit] No eligible tab (http/https/file) to inject into.");return}console.debug("[readit] sendToActiveTabOrInject -> tab",a.id,a.url,"msg",t);try{await chrome.tabs.sendMessage(a.id,t),console.debug("[readit] sent message to content script on tab",a.id)}catch{try{const i=await h(),e=t.kind==="READ_TEXT";let o=e?t.text:null;const l=async n=>{try{const r=await fetch("http://127.0.0.1:4000/speak",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n})});return console.debug("[readit] proxy result",r.status),r.ok}catch(r){return console.warn("[readit] proxy to local helper failed",r),!1}};if(e&&o&&await l(o))return;if(!e)try{const n=await chrome.scripting.executeScript({target:{tabId:a.id},world:"MAIN",func:()=>window.getSelection?.()?.toString().trim()??""}),r=Array.isArray(n)&&n.length>0?n[0].result:n.result;if(console.debug("[readit] selection from page",r),r){if(await l(r))return;o=r}else return}catch(n){console.warn("[readit] failed to read selection via executeScript",n)}await chrome.scripting.executeScript({target:{tabId:a.id},world:"MAIN",func:(n,r,u)=>{try{const c=u??window.getSelection?.()?.toString().trim();if(!c)return;const s=new SpeechSynthesisUtterance(c);if(s.rate=r??1,n){const f=speechSynthesis.getVoices().find(p=>p.name===n);f&&(s.voice=f)}speechSynthesis.cancel(),speechSynthesis.speak(s)}catch(c){console.warn("readit: speak injection failed",c)}},args:[i.voice,i.rate,o]}),console.debug("[readit] executed injection script on tab",a.id)}catch(i){console.warn("[readit] injection fallback failed",i)}}}chrome.commands.onCommand.addListener(async t=>{t==="read-selection"&&await d({kind:"READ_SELECTION"})});chrome.runtime.onMessage.addListener((t,a,i)=>((async()=>{try{if(typeof t=="object"&&t!==null&&"action"in t&&t.action==="proxy-speak"&&"text"in t&&typeof t.text=="string"){const e=t.text;try{const o=await fetch("http://127.0.0.1:4000/speak",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})});i({ok:o.ok,status:o.status})}catch(o){console.warn("[readit] proxy-speak failed",o),i({ok:!1,error:String(o)})}return}if(typeof t=="object"&&t!==null&&"action"in t&&t.action==="probe-tts"){try{const e=await fetch("http://127.0.0.1:4000/ping",{method:"GET"});e.ok?i({ok:!0}):i({ok:!1,status:e.status})}catch(e){i({ok:!1,error:String(e)})}return}w(t)&&await d(t)}catch(e){console.warn("[readit] runtime message handler failed",e)}})(),!0));chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus&&chrome.contextMenus.create({id:"read-selection",title:"Read selection aloud",contexts:["selection"]})});chrome.contextMenus?.onClicked&&chrome.contextMenus.onClicked.addListener(async t=>{t.menuItemId==="read-selection"&&await d({kind:"READ_SELECTION"})});export{d as sendToActiveTabOrInject};
